name: Sync GitHub Assignee to Jira Task

on:
  issues:
    types: [assigned]

permissions:
  issues: read
  contents: read

jobs:
  sync-assignee-to-jira:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Jira Issue Key from GitHub Issue Title
        id: extract-jira
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title
            const match = title.match(/\[([A-Z]+-\d+)\]/)
            if (!match) core.setFailed("No Jira key found in title")
            core.setOutput("jiraKey", match[1])

      - name: Get GitHub Issue Assignee
        id: get-assignee
        run: echo "assignee=${{ github.event.issue.assignee.login }}" >> $GITHUB_OUTPUT

      - name: Jira Login
        uses: atlassian/gajira-login@v3
        with:
          site: ${{ secrets.JIRA_BASE_URL }}
          email: ${{ secrets.JIRA_USER_EMAIL }}
          api-token: ${{ secrets.JIRA_API_TOKEN }}

      - name: Assign Jira Task
        uses: atlassian/gajira-assign@v3
        with:
          issue: ${{ steps.extract-jira.outputs.jiraKey }}
          assignee: ${{ steps.get-assignee.outputs.assignee }}
